<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Formulaire de vente</title>
</head>
<body>
    <h1>Formulaire de vente</h1>

    <form th:action="@{/vente}" th:object="${commande}" method="post" id="formCommande">
        <label for="dateCommande">Date de commande:</label>
        <input type="date" id="dateCommande" th:field="${commande.dateCommande}" name="dateCommande" required><br><br>

        <label for="client">Client:</label>
        <select id="client" th:field="*{client.code}" name="client.code" required>
            <option value="">Sélectionner un client</option>
            <!-- Utilisation de th:each pour afficher les clients -->
            <option th:each="client : ${clients}" th:value="${client.code}" th:text="${client.nom}"></option>
        </select><br><br>
        <input type="submit" value="Enregistrer">
    </form>

    <form th:action="@{/ligneCommande/ajouter}" th:object="${ligneCommande}" method="post" id="formLigneCommande">
        <input type="number" id="numeroCommande" th:field="*{commande.numero}" readonly>
        

        <label for="produit">Produit:</label>
        <select id="produit" th:field="*{produit.ref}" name="produit.ref" required>
            <option value="">Sélectionner un produit</option>
            <!-- Utilisation de th:each pour afficher les produits -->
            <option th:each="produit : ${produits}" th:value="${produit.ref}" th:text="${produit.designation}"></option>
        </select><br><br>

        <label for="qte">Quantité:</label>
        <input type="number" id="qte" th:field="*{qte}" name="qte" required><br><br>

        <input type="submit" value="Ajouter">
    </form>

    <script th:inline="javascript">
    /* <![CDATA[ */
    var formCommande = document.getElementById("formCommande");
    var formLigneCommande = document.getElementById("formLigneCommande");
    var numeroCommandeField = document.getElementById("numeroCommande");

    formCommande.addEventListener("submit", function(event) {
        event.preventDefault();

        // Récupérer les données du formulaire de commande
        var formDataCommande = new FormData(formCommande);

        // Envoyer la requête AJAX pour enregistrer la commande
        fetch(formCommande.getAttribute("action"), {
            method: formCommande.method,
            body: formDataCommande
        })
        .then(function(response) {
            if (response.ok) {
                // Extraire le numéro de commande de la réponse
                response.json().then(function(data) {
                    var numeroCommande = data.numero;

                    // Injecter le numéro de commande dans le formulaire de ligne de commande
                    numeroCommandeField.value = numeroCommande;

                    // Soumettre le formulaire de ligne de commande
                    formLigneCommande.submit();
                });
            } else {
                // Afficher les erreurs de validation
                response.json().then(function(errors) {
                    // Afficher les messages d'erreur à côté des champs
                    Object.keys(errors).forEach(function(fieldName) {
                        var field = formCommande.querySelector("[name='" + fieldName + "']");
                        var errorMessages = errors[fieldName];

                        // Ajouter les messages d'erreur à côté du champ
                        errorMessages.forEach(function(errorMessage) {
                            var errorElement = document.createElement("div");
                            errorElement.className = "error-message";
                            errorElement.textContent = errorMessage;
                            field.parentNode.appendChild(errorElement);
                        });
                    });
                });
            }
        });
    });

    formLigneCommande.addEventListener("submit", function(event) {
        event.preventDefault();

        // Récupérer les données du formulaire de ligne de commande
        var formDataLigneCommande = new FormData(formLigneCommande);

        // Envoyer la requête AJAX pour ajouter la ligne de commande
        fetch(formLigneCommande.getAttribute("action"), {
            method: formLigneCommande.method,
            body: formDataLigneCommande
        })
        .then(function(response) {
            if (response.ok) {
                // Recharger la page
                window.location.reload();
            } else {
                // Afficher les erreurs de validation
                response.json().then(function(errors) {
                    // Afficher les messages d'erreur à côté des champs
                    Object.keys(errors).forEach(function(fieldName) {
                        var field = formLigneCommande.querySelector("[name='" + fieldName + "']");
                        var errorMessages = errors[fieldName];

                        // Ajouter les messages d'erreur à côté du champ
                        errorMessages.forEach(function(errorMessage) {
                            var errorElement = document.createElement("div");
                            errorElement.className = "error-message";
                            errorElement.textContent = errorMessage;
                            field.parentNode.appendChild(errorElement);
                        });
                    });
                });
            }
        });
    });
    /* ]]> */
</script>


</body>
</html>